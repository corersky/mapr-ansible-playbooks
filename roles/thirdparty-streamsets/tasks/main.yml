---
   # Set pre-requisites for Streamsets
   - name: Set ulimit for open files to 63536 for current session
     shell: ulimit -n 63536

   - name: Set hard ulimit for open files to 63536
     vars:
       ulimit: '* hard nofile 63536'
     lineinfile: dest=/etc/security/limits.conf line='{{ulimit}}' state=present

   - name: Set soft ulimit for open files to 63536
     vars:
       ulimit: '* soft nofile 63536'
     lineinfile: dest=/etc/security/limits.conf line='{{ulimit}}' state=present

   - name: Set ulimit in sysctl
     sysctl:
      name: fs.file-max
      value: 63536
      sysctl_set: yes
      state: present
      reload: yes

   # Download Streamsets from local repo (using wget as get_url doesn't support recursive downloads)
   - name: Download Streamsets RPM's from local repo
     shell: wget -r -nc --no-parent -nH --cut-dirs=100 {{ streamsets_repo_url }} -P {{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/
     when: streamsets_repo_url != 'empty'

   # Download Streamsets tarbal
   - name: Download Streamsets (might take some time as it is a 3GB download)
     get_url:
       url: "{{streamsets_download_url}}"
       dest: "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms.tgz"
       timeout: 900
     when: streamsets_repo_url == 'empty'

   - name: Extract Streamsets
     unarchive: src="{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms.tgz" dest="{{streamsets_download_location}}" copy=no
     when: streamsets_repo_url == 'empty'

   - name: Remove all non-relevant Streamsets origins/destinations
     file: path="{{item}}" state=absent
     with_fileglob:
     - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-cdh*.rpm"
     - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-hdp*.rpm"
     - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-apache-kafka*.rpm"
     - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-apache-kudu*.rpm"
     #- "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms.tgz"

   - name: Install Streamsets Datacollector and origins/destinations
     yum: name="{{item}}" state=present
     with_items:
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-apache-solr_6_1_0-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-aws-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-azure-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-basic-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-bigtable-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-cassandra_3-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-elasticsearch_5-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-google-cloud-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-groovy_2_4-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-influxdb_0_9-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-jdbc-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-jks-credentialstore-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-jms-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-jython_2_7-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-mapr_5_0-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-mapr_5_1-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-mapr_5_2-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-mapr_spark_2_1_mep_3_0-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-mongodb_3-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-mysql-binlog-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-omniture-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-rabbitmq-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-redis-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-salesforce-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-stats-lib-2.7.1.0-1.noarch.rpm"
      - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/streamsets-datacollector-vault-credentialstore-lib-2.7.1.0-1.noarch.rpm"
#      - "find /tmp/streamsets-datacollector-2.7.1.0-all-rpms/ -type f -name '*.rpm'"
#     - "{{streamsets_download_location}}/streamsets-datacollector-{{streamsets_version}}-all-rpms/*.rpm"


   # Once installed, configure Streamsets for use with MapR
   - name: Configure Streamsets for use with MapR v{{mapr_version}}
     shell: "streamsets setup-mapr"
     args:
       chdir: /opt/streamsets-datacollector/bin/
     environment:
       SDC_HOME: "/opt/streamsets-datacollector/"
       SDC_DIST: "/opt/streamsets-datacollector/"
       SDC_CONF: "/etc/sdc/"
       MAPR_VERSION: "{{mapr_version}}"
       MAPR_HOME: "/opt/mapr"
       SDC_ALLOW_UNSUPPORTED_JDK: "true"

   # Make changes to run Streamsets as the MapR user
   - name: Change SDC_USER from sdc to mapr
     lineinfile:
       path: /opt/streamsets-datacollector/libexec/sdcd-env.sh
       regexp: '^export SDC_USER='
       line: 'export SDC_USER=mapr'

   - name: Change SDC_GROUP from sdc to mapr
     lineinfile:
       path: /opt/streamsets-datacollector/libexec/sdcd-env.sh
       regexp: '^export SDC_GROUP='
       line: 'export SDC_GROUP=mapr'

   - name: Change owner of files in /etc/sdc/ to mapr:mapr
     file:
       dest: /etc/sdc/
       owner: mapr
       group: mapr
       recurse: yes

   - name: Change owner of files in /opt/streamsets-datacollector/ to mapr:mapr
     file:
       dest: /opt/streamsets-datacollector/
       owner: mapr
       group: mapr
       recurse: yes

   # Make changes to run Streamsets as the MapR user
   - name: Start the Streamsets Datacollector service (sdc)
     service:
       name: sdc
       state: started
       enabled: yes
       use: service
