---
  # Set pre-requisites for Streamsets
  - name: Install Docker
    package: name={{item}} state=present
    with_items:
      - docker
      - docker-compose
  
  # Configure http proxy for Docker if required
  - name: Configure http proxy for Docker
    blockinfile:
      dest: /etc/systemd/system/docker.service.d/http-proxy.conf
      block: |
        [Service]
        Environment="HTTP_PROXY={{proxy_http_url}}"
  
  #- name: Configure http proxy for Docker
  # lineinfile: dest=/etc/systemd/system/docker.service.d/http-proxy.conf line="{{ item.line }}"
  # with_items:
  # - '[Service]' }
  # - { line: 'Environment="HTTP_PROXY={{proxy_http_url}}"' }
  # when: "{{proxy}}" == 'yes'

  # Launch Streamsets service sdc
  - name: Start the Docker service
    service:
      name: docker
      state: started
      enabled: yes
      use: service

  - name: Create the docker group
    group:
      name: docker
      state: present

  - name: Make user 'root' part of the 'docker' group
    user:
      name: root
      groups: docker
      append: yes

  - name: Make user '{{mapr_user}}' part of the 'docker' group
    user:
      name: "{{mapr_user}}"
      groups: docker
      append: yes

  - name: Make user 'sdc' (Streamsets) part of the 'docker' group
    user:
      name: sdc
      groups: docker
      append: yes

  - name: Allow user 'sdc' (Streamsets) to sudo for docker
    vars:
      sudoers: 'sdc ALL = NOPASSWD: /usr/bin/docker'
    lineinfile: dest=/etc/sudoers line='{{sudoers}}' state=present
